# Amazon Titan Image Generatorを活用したiOS画像生成アプリケーション仕様書

## 1. 概要

### 1.1 プロジェクト概要
本仕様書は、Amazon Titan Image Generatorを使用してテキストプロンプトから画像を生成するiOSアプリケーションの開発に関する技術仕様を定義します。ユーザーはテキスト入力から画像を生成し、必要に応じて既存画像の編集や加工も可能とします。

### 1.2 アーキテクチャ概要
本アプリケーションは、iOSアプリケーションがAWS SDK for Swiftを介して直接AWSサービスと連携するモデルを採用します。具体的には、Amazon Cognito Identity Poolsを使用して一時的なAWS認証情報を取得し、その認証情報を使用してAmazon Bedrock内のTitan Image Generator APIを呼び出します。

## 2. 技術仕様

### 2.1 開発環境
- **OS**: 最新バージョンのmacOS
- **IDE**: 最新バージョンのXcode（現行のAWS SDKをサポートする最新版）
- **言語**: Swift
- **UIフレームワーク**: SwiftUI（推奨）またはUIKit
- **依存関係管理**: Swift Package Manager (SPM)

### 2.2 AWS環境設定
- **リージョン選択**: Amazon Titan Image Generatorが利用可能なリージョンを選択（例: us-east-1）
- **モデルアクセス**: 選択したリージョンでAmazon Titan Image Generator（例: amazon.titan-image-generator-v1または最新版）へのアクセスを有効化

### 2.3 必要なSDKモジュール
Swift Package Managerを使用して以下のモジュールを追加します：
- AWS Core（AWSCore）: 基本設定と認証情報処理
- AWS Bedrock Runtime（AWSBedrockRuntime）: Titan Image Generator APIとの通信
- AWS Cognito Identity（AWSCognitoIdentity）: 認証情報取得

### 2.4 認証とセキュリティ
- **認証方式**: Amazon Cognito Identity Poolsを使用
- **アクセスタイプ**: 「認証されていないID」を有効化（ユーザーアカウントなしでアクセス可能）
- **IAMロール**: 最小権限の原則に基づいたロールを作成
- **IAMポリシー**: 以下の権限のみを持つカスタムポリシーを作成
  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": "bedrock:InvokeModel",
        "Resource": "arn:aws:bedrock:<region>::foundation-model/amazon.titan-image-generator-v1"
      }
    ]
  }
  ```

## 3. アプリケーション機能仕様

### 3.1 画像生成機能
- **テキストプロンプト入力**: ユーザーが生成したい画像を説明するテキストを入力
- **ネガティブプロンプト**: 生成から除外したい要素を指定（任意）
- **画像生成パラメータ設定**:
  - 画像サイズ（幅/高さ）
  - 品質（標準/プレミアム）
  - 生成数
  - プロンプト忠実度（CFGスケール）
  - シード値（再現性用、任意）

### 3.2 画像表示と保存
- 生成された画像をアプリ内で表示
- 画像の保存機能（デバイスのフォトライブラリへ）
- 画像の共有機能（iOS標準の共有シート使用）

### 3.3 ダウンロードと共有機能
- **ダウンロード機能**:
  - 生成された画像をデバイスに直接ダウンロードして保存
  - ダウンロード進捗表示
  - ダウンロード完了通知
  - ファイル形式選択（PNG/JPEG）とクオリティ設定
  
- **共有機能**:
  - iOS標準の共有シートを利用した多様な共有オプション
  - SNS（Twitter、Instagram、Facebook等）への直接共有
  - メール、メッセージアプリでの送信
  - AirDropによる近くのデバイスへの送信
  - 「Files」アプリへの保存

### 3.4 ユーザーインターフェース
- プロンプト入力フォーム
- 生成パラメータ設定UI
- 生成中のローディングインジケーター
- 生成された画像の表示エリア
- ダウンロードと共有のためのアクションボタン
- 履歴表示（任意・拡張機能）

## 4. 技術実装ガイドライン

### 4.1 AWS SDKの初期化
- AppDelegateまたはアプリ起動時にAWS SDKを初期化
- Cognito Identity PoolのIDとリージョンを設定
- 認証情報プロバイダーを設定

### 4.2 Titan Image Generator API呼び出し
- InvokeModelオペレーションを使用
- リクエストパラメータ例:
  ```json
  {
    "taskType": "TEXT_IMAGE",
    "textToImageParams": {
      "text": "<ユーザー入力したプロンプト>",
      "negativeText": "<ネガティブプロンプト>"
    },
    "imageGenerationConfig": {
      "numberOfImages": 1,
      "quality": "standard",
      "width": 1024,
      "height": 1024,
      "cfgScale": 7.5,
      "seed": 0
    }
  }
  ```

### 4.3 非同期処理
- Swift `async/await`を使用して非同期API呼び出しを実装
- バックグラウンドスレッドでAPI呼び出しを行い、UIスレッドをブロックしない
- 生成処理中はユーザーに適切なフィードバックを提供

### 4.4 エラー処理
- 包括的なエラーハンドリングを実装
- 次のエラータイプに対する処理を考慮:
  - ネットワークエラー
  - AWS SDK関連エラー
  - Bedrockサービスエラー（スロットリング、アクセス拒否、バリデーションなど）
  - Cognitoエラー
- ユーザーに分かりやすいエラーメッセージを表示

### 4.5 データ処理
- Base64エンコード/デコード処理の効率的な実装
- 大きなデータの処理はバックグラウンドスレッドで実行

### 4.6 ダウンロードと共有の実装
- **ダウンロード機能の実装**:
  - `UIImage`オブジェクトをファイルシステムに保存
  - `FileManager`APIを使用したファイル操作
  - バックグラウンド処理での実装
  - 適切なエラーハンドリング

- **共有機能の実装**:
  - `UIActivityViewController`を使用した共有シートの表示
  - 共有アイテムの設定（画像、テキスト等）
  - iPad対応（ポップオーバー表示）
  - 共有完了・キャンセル処理

## 5. 拡張機能（将来実装）

### 5.1 追加タスクタイプの実装
- インペインティング（画像の一部を選択して生成）
- アウトペインティング（画像の外側を拡張）
- 画像バリエーション生成

### 5.2 ユーザー体験の向上
- 過去のプロンプトと生成結果の履歴保存
- お気に入りプロンプトの保存
- プロンプトテンプレート機能
- 複数画像一括ダウンロード機能
- カスタム透かし機能

### 5.3 代替アーキテクチャ
- バックエンドプロキシを使用したアーキテクチャへの移行検討（API Gateway + Lambda）
  - より高度な制御
  - セキュリティ強化
  - サーバーサイドでのリクエスト前処理、後処理

## 6. 運用上の考慮事項

### 6.1 コスト管理
- Amazon Titanモデルの料金体系を理解
- 使用量モニタリングの実装（任意）
- 必要に応じて使用量制限の実装

### 6.2 サービス制限
- Bedrock APIのクォータと制限を理解
- 適切なリトライロジックの実装（特にスロットリングエラー発生時）

### 6.3 ロギングとモニタリング
- アプリ内での主要イベントのロギング
- AWS CloudTrailを利用したAPI呼び出しの監視（必要に応じて）

## 7. 実装ステップ

1. AWS環境の設定
   - AWSアカウントの準備
   - リージョン選択とTitan Image Generatorモデルへのアクセス有効化
   - Cognito Identity Poolの作成とIAMロールの設定

2. Xcodeプロジェクトの設定
   - プロジェクト作成
   - Swift Package ManagerでAWS SDKを追加
   - 基本的なUI構造の設計

3. AWS SDK初期化部分の実装
   - Cognitoクレデンシャルプロバイダーの設定
   - BedrockRuntime SDKの初期化

4. API呼び出し部分の実装
   - InvokeModelリクエストの構築
   - 非同期処理の実装
   - レスポンス処理（Base64デコードなど）

5. UIの実装
   - プロンプト入力フォーム
   - パラメータ設定UI
   - 画像表示領域
   - ローディングインジケーター
   - ダウンロードと共有ボタンの実装

6. ダウンロードと共有機能の実装
   - ダウンロード機能の実装
   - 共有機能の実装
   - 適切なフィードバックの提供

7. エラー処理とフィードバック
   - 包括的なエラーハンドリング
   - ユーザーフィードバックの実装

8. 追加機能実装とテスト
   - 画像保存機能
   - 共有機能
   - 全体テスト

## 8. まとめ

本仕様書は、Amazon Titan Image Generatorを活用したiOS画像生成アプリケーションの開発に必要な技術要件と実装ガイドラインを提供しています。Swift Package Managerを使用したSDK統合、Cognito Identity Poolsによる安全な認証、非同期処理などのベストプラクティスに基づいた実装を推奨します。

ユーザビリティを高めるためのダウンロード機能と共有機能を含め、使いやすく直感的なインターフェースを提供することで、ユーザーがテキストから簡単に画像を生成し、結果を保存・共有できるアプリケーションを目指します。

アプリの初期バージョンでは直接AWSサービス呼び出しのアーキテクチャを採用しますが、セキュリティ要件やアプリ機能の拡張に応じて、将来的にバックエンドプロキシアーキテクチャへの移行も検討することを推奨します。